name: Deploy to EC2 (PM2)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

concurrency:
  group: deploy-o2d-backend
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore .env (persistent on EC2)
        run: |
          if [ ! -f "/home/ubuntu/secrets/o2d-backend/.env" ]; then
            echo "❌ Missing /home/ubuntu/secrets/o2d-backend/.env"
            exit 1
          fi
          cp /home/ubuntu/secrets/o2d-backend/.env .env
          chmod 600 .env
          echo "✅ .env restored"

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Start/Restart Backend (PM2)
        run: |
          pm2 describe o2d-backend >/dev/null 2>&1 \
            && pm2 restart o2d-backend --update-env --cwd "$(pwd)" \
            || pm2 start server.cjs --name o2d-backend --cwd "$(pwd)"
          pm2 save

      - name: Health check logs (last 40 lines)
        run: pm2 logs o2d-backend --lines 40 --nostream
