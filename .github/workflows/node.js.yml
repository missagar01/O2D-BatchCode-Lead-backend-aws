name: Deploy Backend to EC2 (PM2)

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies (CI)
        run: npm ci

      - name: Build (if present)
        run: npm run build --if-present

      # ---- DEPLOY TO SERVER PATH ----
      - name: Deploy to /var/www/o2d-backend (keep .env)
        run: |
          sudo mkdir -p /var/www/o2d-backend
          sudo chown -R $USER:$USER /var/www/o2d-backend

          rsync -av --delete \
            --exclude ".git/" \
            --exclude "node_modules/" \
            --exclude ".env" \
            --exclude ".env.*" \
            ./ /var/www/o2d-backend/

      - name: Install production dependencies on server
        working-directory: /var/www/o2d-backend
        run: npm ci --omit=dev

      # ---- PM2 RESTART ----
      - name: Restart PM2
        working-directory: /var/www/o2d-backend
        run: |
          pm2 describe o2d-backend >/dev/null 2>&1 && pm2 restart o2d-backend || pm2 start server.js --name o2d-backend
          pm2 save
